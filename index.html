<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>affirmations</title>
        <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .entry {
                border: 1px solid #ccc;
                padding: 15px;
                margin: 10px 0;
                border-radius: 5px;
            }
            .screenshot {
                max-width: 100%;
                height: auto;
                margin-top: 10px;
            }
            .auth-form,
            #uploadForm {
                margin-bottom: 30px;
                border: 1px solid #ddd;
                padding: 20px;
            }
            input,
            textarea,
            button {
                display: block;
                margin: 10px 0;
                width: 100%;
                padding: 8px;
            }
            .user-badge {
                color: #666;
                font-size: 0.9em;
                margin-bottom: 5px;
            }
        </style>
    </head>
    <body>
        <div id="authSection">
            <div class="auth-form">
                <h1>Login</h1>
                <input type="email" id="email" placeholder="Email" />
                <input type="password" id="password" placeholder="Password" />
                <button onclick="login()">Login</button>
                    <button onclick="register()">Register</button>
                </div>
                <div class="auth-form">
                    <h1>Send Invitation</h1>
                    <input type="email" id="inviteEmail" placeholder="Invitee Email" />
                    <button onclick="sendInvite()">Send Invite</button>
            </div>
                <div class="auth-form">
                    <h1>Pending Invitations</h1>
                    <div id="pendingInvites"></div>
                </div>
            </div>
            <div id="contentSection" style="display: none">
                <h1>affirmations ðŸ’™ðŸ’œ</h1>
                <form id="uploadForm">
                    <input type="file" id="fileInput" accept="image/*" />
                    <textarea
                        id="textInput"
                        placeholder="What did you want to say?"
                    ></textarea>
                    <button type="button" onclick="submitEntry()">Send <3</button>
                </form>
        </div>

        <div id="contentSection" style="display: none">
            <h1>affirmations ðŸ’™ðŸ’œ</h1>
            <form id="uploadForm">
                <input type="file" id="fileInput" accept="image/*" />
                <textarea
                    id="textInput"
                    placeholder="What did you want to say?"
                ></textarea>
                <button type="button" onclick="submitEntry()">Send <3</button>
            </form>

            <div id="entriesContainer"></div>
        </div>

        <script>
            const pb = new PocketBase("https://chel-api.james.baby"); // Replace with your PocketBase URL

            // Authentication functions
            async function login() {
                try {
                    await pb
                        .collection("users")
                        .authWithPassword(
                            document.getElementById("email").value,
                            document.getElementById("password").value,
                        );
                    refreshUI();
                    loadEntries();
                } catch (error) {
                    alert("Login failed: " + error.message);
                }
            }

            async function register() {
                try {
                    // Add a 'connections' field to the user data
                    // This will be a list of user IDs that the user is connected to
                    await pb.collection("users").create({
                        email: document.getElementById("email").value,
                        password: document.getElementById("password").value,
                        passwordConfirm:
                            document.getElementById("password").value,
                        connections: [], // Add a connections array, initially empty
                    });
                    await login();
                } catch (error) {
                    alert("Registration failed: " + error.message);
                }
            }

            function logout() {
                pb.authStore.clear();
                refreshUI();
            }

            // UI state management
            function refreshUI() {
                if (pb.authStore.isValid) {
                    document.getElementById("authSection").style.display =
                        "none";
                    document.getElementById("contentSection").style.display =
                        "block";
                } else {
                    document.getElementById("authSection").style.display =
                        "block";
                    document.getElementById("contentSection").style.display =
                        "none";
                }
            }

            // Entry submission
            async function submitEntry() {
                if (!pb.authStore.isValid) return alert("Please login first!");

                const formData = new FormData();
                formData.append(
                    "screenshot",
                    document.getElementById("fileInput").files[0],
                );
                formData.append(
                    "whattosay",
                    document.getElementById("textInput").value,
                );
                formData.append("user", pb.authStore.model.id);
                // Add a 'connection' field to the message data
                // This will store which connection is being referenced in this message
                // This field will reference a user1-user2 pair in the 'connections' collection
                const userConnections = (await pb.collection("users").getOne(pb.authStore.model.id)).connections
                if(userConnections.length > 0){
                    formData.append("connection", userConnections[0]);
                }

                try {
                    await pb.collection("messages").create(formData);
                    document.getElementById("fileInput").value = "";
                    document.getElementById("textInput").value = "";
                    loadEntries();
                } catch (error) {
                    alert("Error submitting entry: " + error.message);
                }
            }

            async function sendInvite() {
                try {
                    const inviteeEmail = document.getElementById("inviteEmail").value;
                    const invitee = await pb.collection("users").getFirstListItem({
                        filter: `email = "${inviteeEmail}"`
                    });
                    const inviterId = pb.authStore.model.id;
                    // Create a new entry in the 'invitations' collection
                    await pb.collection("invitations").create({
                        inviter: inviterId,
                        invitee: invitee.id,
                        status: "pending",
                    });

                    alert('Invite sent successfully!');
                } catch (error) {
                    alert("Failed to send invite: " + error.message);
                }
            }
            // Load pending invites with user information
            async function loadPendingInvites() {
                try {
                    const invites = await pb
                        .collection("invitations")
                        .getFullList({
                            expand: "inviter, invitee",
                            sort: "-created",
                        });

                    const container =
                        document.getElementById("pendingInvites");
                    container.innerHTML = "";

                    invites.forEach((invite) => {
                        const inviteDiv = document.createElement("div");
                        inviteDiv.className = "invite";

                        const inviterBadge = document.createElement("div");
                        inviterBadge.className = "inviter-badge";
                        inviterBadge.textContent = `From: ${invite.expand.inviter.name || "Anonymous"}`;

                        const inviteeBadge = document.createElement("div");
                        inviteeBadge.className = "invitee-badge";
                        inviteeBadge.textContent = `To: ${invite.expand.invitee.name || "Anonymous"}`;

                        const acceptButton = document.createElement("button");
                        acceptButton.textContent = "Accept";
                        acceptButton.onclick = () => acceptInvite(invite.id);

                        const rejectButton = document.createElement("button");
                        rejectButton.textContent = "Reject";
                        rejectButton.onclick = () => rejectInvite(invite.id);

                        inviteDiv.appendChild(inviterBadge);
                        inviteDiv.appendChild(inviteeBadge);
                        inviteDiv.appendChild(acceptButton);
                        inviteDiv.appendChild(rejectButton);
                        container.appendChild(inviteDiv);
                    });
                } catch (error) {
                    alert("Error loading invites: " + error.message);
                }
            }

            // New function to accept invites
            async function acceptInvite(inviteId) {
                try {
                    const invite = await pb.collection("invitations").getOne(inviteId, {expand: 'inviter,invitee'})
                    await linkUsers(invite.expand.inviter.id, invite.expand.invitee.id)
                    await pb.collection("invitations").update(inviteId, {status: 'accepted'})
                } catch (error) {
                    alert("Failed to accept invite: " + error.message);
                }
            }

            async function rejectInvite(inviteId){
                try {
                    await pb.collection("invitations").update(inviteId, {status: 'rejected'})
                } catch (error) {
                    alert("Failed to reject invite: " + error.message);
                }
            }
            // Load entries with user information
            async function loadEntries() {
                try {
                    const entries = await pb
                        .collection("messages")
                        .getFullList({
                            expand: "user, connection",
                            sort: "-created",
                        });

                    const container =
                        document.getElementById("entriesContainer");
                    container.innerHTML = "";

                    entries.forEach((entry) => {
                        const entryDiv = document.createElement("div");
                        entryDiv.className = "entry";

                        const userBadge = document.createElement("div");
                        userBadge.className = "user-badge";
                        userBadge.textContent = `${entry.expand.user.name || "Anonymous"}`;

                        const text = document.createElement("h2");
                        text.textContent = entry.whattosay;

                        const img = document.createElement("img");
                        img.className = "screenshot";
                        img.src = pb.files.getUrl(entry, entry.screenshot);

                        entryDiv.appendChild(userBadge);
                        entryDiv.appendChild(text);
                        entryDiv.appendChild(img);
                        container.appendChild(entryDiv);
                    });
                } catch (error) {
                    alert("Error loading entries: " + error.message);
                }
            }

            // Initial setup
            refreshUI();
            loadEntries();
            loadPendingInvites();
        </script>
    </body>
</html>
=======
            // Entry submission
            async function submitEntry() {
                if (!pb.authStore.isValid) return alert("Please login first!");

                const formData = new FormData();
                formData.append(
                    "screenshot",
                    document.getElementById("fileInput").files[0],
                );
                formData.append(
                    "whattosay",
                    document.getElementById("textInput").value,
                );
                formData.append("user", pb.authStore.model.id);
                // Add a 'connection' field to the message data
                // This will store which connection is being referenced in this message
                // This field will reference a user1-user2 pair in the 'connections' collection
                const userConnections = (await pb.collection("users").getOne(pb.authStore.model.id)).connections
                if(userConnections.length > 0){
                    formData.append("connection", userConnections[0]);
                }

                try {
                    await pb.collection("messages").create(formData);
                    document.getElementById("fileInput").value = "";
                    document.getElementById("textInput").value = "";
                    loadEntries();
                } catch (error) {
                    alert("Error submitting entry: " + error.message);
                }
            }

            async function sendInvite() {
                try {
                    const inviteeEmail = document.getElementById("inviteEmail").value;
                    const invitee = await pb.collection("users").getFirstListItem({
                        filter: `email = "${inviteeEmail}"`
                    });
                    const inviterId = pb.authStore.model.id;
                    // Create a new entry in the 'invitations' collection
                    await pb.collection("invitations").create({
                        inviter: inviterId,
                        invitee: invitee.id,
                        status: "pending",
                    });

                    alert('Invite sent successfully!');
                } catch (error) {
                    alert("Failed to send invite: " + error.message);
                }
            }
            
            // New function to handle user linking
            async function linkUsers(userId1, userId2) {
                try {
                    // Create a new entry in the 'connections' collection
                    await pb.collection("connections").create({
                        user1: userId1,
                        user2: userId2,
                    });

                    // Add the connection to each user's 'connections' list
                    await pb.collection("users").update(userId1, {
                        connections: [...(await pb.collection("users").getOne(userId1)).connections, userId2]
                    })
                    await pb.collection("users").update(userId2, {
                        connections: [...(await pb.collection("users").getOne(userId2)).connections, userId1]
                    })

                    alert('Users linked successfully!');
                } catch (error) {
                    alert("Failed to link users: " + error.message);
                }
            }
            // Load entries with user information
            async function loadEntries() {
                try {
                    const entries = await pb
                        .collection("messages")
                        .getFullList({
                            expand: "user, connection",
                            sort: "-created",
                        });

                    const container =
                        document.getElementById("entriesContainer");
                    container.innerHTML = "";

                    entries.forEach((entry) => {
                        const entryDiv = document.createElement("div");
                        entryDiv.className = "entry";

                        const userBadge = document.createElement("div");
                        userBadge.className = "user-badge";
                        userBadge.textContent = `${entry.expand.user.name || "Anonymous"}`;

                        const text = document.createElement("h2");
                        text.textContent = entry.whattosay;

                        const img = document.createElement("img");
                        img.className = "screenshot";
                        img.src = pb.files.getUrl(entry, entry.screenshot);

                        entryDiv.appendChild(userBadge);
                        entryDiv.appendChild(text);
                        entryDiv.appendChild(img);
                        container.appendChild(entryDiv);
                    });
                } catch (error) {
                    alert("Error loading entries: " + error.message);
                }
            }

            // Initial setup
            refreshUI();
            loadEntries();
        </script>
    </body>
</html>

            // Load entries with user information
            async function loadEntries() {
                try {
                    const entries = await pb
                        .collection("messages")
                        .getFullList({
                            expand: "user, connection",
                            sort: "-created",
                        });

                    const container =
                        document.getElementById("entriesContainer");
                    container.innerHTML = "";

                    entries.forEach((entry) => {
                        const entryDiv = document.createElement("div");
                        entryDiv.className = "entry";

                        const userBadge = document.createElement("div");
                        userBadge.className = "user-badge";
                        userBadge.textContent = `${entry.expand.user.name || "Anonymous"}`;

                        const text = document.createElement("h2");
                        text.textContent = entry.whattosay;

                        const img = document.createElement("img");
                        img.className = "screenshot";
                        img.src = pb.files.getUrl(entry, entry.screenshot);

                        entryDiv.appendChild(userBadge);
                        entryDiv.appendChild(text);
                        entryDiv.appendChild(img);
                        container.appendChild(entryDiv);
                    });
                } catch (error) {
                    alert("Error loading entries: " + error.message);
                }
            }

            // Initial setup
            refreshUI();
            loadEntries();
        </script>
    </body>
</html>
